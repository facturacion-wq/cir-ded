<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CIR · Deuda Cliente</title>
<style>
  body {
    background:#0f172a;
    color:#fff;
    font-family: system-ui, Inter, Roboto, sans-serif;
    margin:0;
    padding:2rem;
    display:flex;
    flex-direction:column;
    gap:1.5rem;
  }
  .card {
    background:#1e253a;
    border:1px solid rgba(0,229,143,.2);
    border-radius:1rem;
    padding:1rem 1.5rem;
    box-shadow:0 30px 80px rgba(0,0,0,.8);
  }
  .row {
    display:flex;
    flex-wrap:wrap;
    gap:1rem;
    align-items:flex-end;
  }
  label{
    font-size:.8rem;
    opacity:.8;
    display:block;
    margin-bottom:.25rem;
  }
  input{
    background:#0f172a;
    border:1px solid rgba(0,229,143,.4);
    border-radius:.5rem;
    color:#fff;
    padding:.75rem 1rem;
    font-size:1rem;
    min-width:140px;
  }
  button{
    background:#00e58f;
    color:#000;
    font-weight:600;
    border:0;
    border-radius:.5rem;
    padding:.8rem 1.2rem;
    cursor:pointer;
    font-size:1rem;
  }
  h1,h2{
    margin:0;
    font-weight:600;
    color:#00e58f;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:.9rem;
  }
  th,td{
    text-align:left;
    padding:.5rem .75rem;
    border-bottom:1px solid rgba(255,255,255,.07);
  }
  th{
    font-weight:500;
    color:#00e58f;
    font-size:.8rem;
    text-transform:uppercase;
    letter-spacing:.05em;
  }
  .vencida{
    color:#ff6b6b;
    font-weight:600;
  }
  .totalBox{
    font-size:1.2rem;
    font-weight:600;
  }
</style>
</head>
<body>

<div class="row card">
  <div>
    <label>Código Cliente (sin corchetes)</label>
    <input id="cli" placeholder="000010">
  </div>
  <div>
    <button id="btnBuscar">Consultar deuda</button>
  </div>
  <div style="margin-left:auto">
    <div style="font-size:.75rem;opacity:.6">Estado</div>
    <div id="status" style="font-size:.9rem;font-weight:500;">Esperando...</div>
  </div>
</div>

<div class="card">
  <h1>Detalle de deuda</h1>
  <div class="totalBox" id="totalVencido">$ 0,00 vencido</div>
  <div style="font-size:.8rem;opacity:.7" id="nombreCliente"></div>

  <div style="overflow-x:auto;margin-top:1rem;">
    <table>
      <thead>
        <tr>
          <th>Cbte</th>
          <th>Emisión</th>
          <th>Vto</th>
          <th>Vencido</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody id="tbodyFacturas">
        <tr><td colspan="5" style="opacity:.5;padding:2rem;text-align:center;">Sin datos</td></tr>
      </tbody>
    </table>
  </div>

  <div style="margin-top:1rem;">
    <button id="btnWhatsapp">Generar WhatsApp</button>
  </div>
</div>

<script>
  const API_BASE = "https://script.google.com/macros/s/AKfycbwVF9Yg1m8yieuCiAuAjj6Tf11-WxRpobTcB1fmQhY-f6zBQ4KjQna5CmEq8RnphGQDYA/exec"; 
  // ↑ poné acá la URL real de tu deployment Apps Script
  
  const $ = s => document.querySelector(s);
  
  const fmtMoney = n => {
    const v = Number(n||0);
    return "$ " + v.toLocaleString("es-AR", {
      minimumFractionDigits:2,
      maximumFractionDigits:2
    });
  };
  
  // Lógica principal: pedir datos del cliente
  function solicitarDeuda(clienteId){
    if(!clienteId){
      $("#status").textContent = "Falta cliente";
      return;
    }
    $("#status").textContent = "Buscando...";
  
    // armamos nombre de callback único
    const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*100000);
    window[cbName] = function(data){
      // cuando Apps Script responde, entra acá
      try {
        if (data && !data.error){
          renderDeuda(data);
          $("#status").textContent = "OK";
        } else {
          $("#status").textContent = data.error || "Sin datos";
        }
      } finally {
        // limpieza: sacamos el <script> que inyectamos y borramos callback
        cleanupJSONP(cbName);
      }
    };
  
    // inyectamos <script> para JSONP
    const url = API_BASE
      + "?cliente=" + encodeURIComponent(clienteId)
      + "&callback=" + encodeURIComponent(cbName);
  
    const scriptTag = document.createElement("script");
    scriptTag.src = url;
    scriptTag.id  = cbName;
    scriptTag.onerror = function(){
      $("#status").textContent = "Error al cargar API";
      cleanupJSONP(cbName);
    };
    document.body.appendChild(scriptTag);
  }
  
  // Limpia callback y <script>
  function cleanupJSONP(cbName){
    // borra la función global
    try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
    // remueve el <script>
    const s = document.getElementById(cbName);
    if (s && s.parentNode) s.parentNode.removeChild(s);
  }
  
  // Pinta en pantalla
  function renderDeuda(data){
    // total vencido
    $("#totalVencido").textContent = fmtMoney(data.totalVencido) + " vencido";
  
    // nombre
    let nombre = "";
    if (data.facturas && data.facturas.length){
      nombre = data.facturas[0].cliente || "";
    }
    $("#nombreCliente").textContent = nombre;
  
    // tabla
    const tb = $("#tbodyFacturas");
    tb.innerHTML = "";
    if (!data.facturas || !data.facturas.length){
      tb.innerHTML = `
        <tr>
          <td colspan="5" style="opacity:.5;padding:2rem;text-align:center;">
            Sin facturas abiertas
          </td>
        </tr>`;
    } else {
      data.facturas.forEach(f => {
        const vencidoTxt = f.vencida
          ? (f.diasVencido === 0 ? "HOY" : (f.diasVencido+"d"))
          : "-";
  
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${f.tipo} ${f.pv}-${f.nro}</td>
          <td>${f.emision}</td>
          <td>${f.vto}</td>
          <td style="color:${f.vencida ? '#ff6b6b' : '#fff'};font-weight:${f.vencida?600:400};">
            ${vencidoTxt}
          </td>
          <td>${fmtMoney(f.saldo)}</td>
        `;
        tb.appendChild(tr);
      });
    }
  
    // pre-armar mensaje WhatsApp
    $("#btnWhatsapp").dataset.msg = buildWhatsappMsg(data);
  }
  
  function buildWhatsappMsg(data){
    let nombre = "";
    if (data.facturas && data.facturas.length){
      nombre = data.facturas[0].cliente || "";
    }
  
    const lines = [];
    lines.push(`Hola ${nombre}, ¿cómo va? Soy del área de cuentas de CIR.`);
    lines.push(`Al día de hoy vemos:`);
  
    (data.facturas || [])
      .filter(f=>f.vencida)
      .forEach(f=>{
        lines.push(`• ${f.tipo} ${f.pv}-${f.nro} | Emisión ${f.emision} | Vto ${f.vto} | Saldo ${fmtMoney(f.saldo)} (${f.diasVencido}d vencida)`);
      });
  
    lines.push(`Total vencido: ${fmtMoney(data.totalVencido)}`);
    lines.push(`¿Podemos coordinar el pago?`);
  
    return lines.join("\n");
  }
  
  // Botón "Consultar deuda"
  $("#btnBuscar").addEventListener("click", ()=>{
    const cli = $("#cli").value.trim();
    solicitarDeuda(cli);
  });
  
  // Botón "Generar WhatsApp"
  $("#btnWhatsapp").addEventListener("click", ()=>{
    const msg = $("#btnWhatsapp").dataset.msg || "";
    if(!msg){
      alert("Consultá primero un cliente.");
      return;
    }
    // Abrimos WhatsApp Web con el texto
    const url = "https://wa.me/?text=" + encodeURIComponent(msg);
    window.open(url, "_blank");
  });
  
  // OPCIONAL: autoload de un cliente de prueba al abrir la página.
  // Descomentá esto si querés que apenas abras ya cargue algo y deje de estar en "Esperando...":
  // window.addEventListener("load", ()=>{
  //   $("#cli").value = "000010"; // código cliente demo
  //   solicitarDeuda("000010");
  // });
  </script>
  
</body>
</html>
